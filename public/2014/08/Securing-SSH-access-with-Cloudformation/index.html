<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8" />
    <title>ig.nore.me | Connecting the dots</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="alternate" type="application/rss+xml" title="ig.nore.me &raquo; Feed" href="http://ig.nore.me/feed/" />
    <script type='text/javascript' src='/js/jquery.js?ver=1.11.0'></script>
    <script type='text/javascript' src='/js/jquery-migrate.min.js?ver=1.2.1'></script>
    <script type='text/javascript' src='/js/fitvids.min.js?ver=1.0'></script>
    <script type='text/javascript' src='js/modernizr.min.js?ver=2.6.2'></script>
    <script type='text/javascript' src='/js/general.js?ver=3.9.1'></script>
    <link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://ig.nore.me/xmlrpc.php?rsd" />
    <meta name="generator" content="hugo" />

    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    
    <meta content="initial-scale=1.0; maximum-scale=1.0; user-scalable=no" name="viewport"/>
    

    <meta property="og:type" content="website" />
    <meta property="og:title" content="ig.nore.me" />
    <meta property="og:description" content="Connecting the dots" />
    <meta property="og:url" content="http://ig.nore.me/" />
    <meta property="og:site_name" content="ig.nore.me" />
    <meta property="og:image" content="http://wordpress.com/i/blank.jpg" />
    <meta name="twitter:site" content="@arjenschwarz" />
    <meta name="twitter:author" content="@arjenschwarz" />

    <link rel='stylesheet' id='theme-stylesheet-css'  href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' id='woo-layout-css'  href='/css/layout.css' type='text/css' media='all' />

    <link href="/css/custom.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link href="/css/default.css" rel="stylesheet" type="text/css" />

    <style type="text/css">
        #logo img {
            display:none;
        }
        .site-title {
            display:block !important;
        }
        .site-description {
            display:none !important;
        }
        @media only screen and (min-width: 1024px) {
            #header  {
                background-color: ;
                background-image: url('//assets2.nore.me/hero-image.jpg');
                background-position: top left;
                background-repeat: no-repeat;
                background-size: cover;

            }
        }
        @media only screen and (min-width: 768px) {
            .page #post-entries a,
            .single-post #post-entries a,
            .single-product #post-entries a  {
                background-color: ;
            }
        }
    </style>
</head>

<body class="single single-post postid-81 single-format-standard chrome alt-style-default layout-default">

<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5FGCHK"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5FGCHK');</script>


<div id="wrapper">
    <div id="inner-wrapper">

    <header id="header">

        <span class="nav-toggle"><a href="#navigation"><span>Navigation</span></a></span>

        <hgroup>
            <h1 class="site-title"><a href="http://ig.nore.me/">ig.nore.me</a></h1>
            <h2 class="site-description">Connecting the dots</h2>
        </hgroup>

        <nav id="navigation" class="col-full" role="navigation">
            <section class="menus">
            <a href="/" class="nav-home"><span>Home</span></a>
            <ul id="main-nav" class="nav">
                <li class="page_item current_page_item"><a href="http://ig.nore.me/">Home</a></li>
                <li class="page_item page-item-7"><a href="http://ig.nore.me/about/">About</a></li>
            </ul>
            <ul class="nav rss">
                <li class="sub-rss"><a href="http://ig.nore.me/feed/">RSS</a></li>
            </ul>
            </section>

            <a href="#top" class="nav-close"><span>Return to Content</span></a>

        </nav>


    </header>

    <div id="content" class="col-full">
        <section id="main">
            <article class="post type-post status-publish format-standard hentry">
                
                <header style="background-image: url('//assets2.nore.me/categories/category-aws-full.jpg' ); ?>); background-size: cover; background-position: center center;" >
                
                    <section class="header-content">
                        <h1>Securing SSH access with Cloudformation</h1>
                            <aside class="post-meta">
                                <span class="post-date">August 10, 2014</span>
                                <span class="post-category">in
                                    
                                        <a href="/categories/aws" title="View all posts in aws" rel="category tag">aws</a>
                                    
                                </span>
                            </aside>
                    </section>

                    <nav id="post-entries" class="fix">
                        <div class="nav-prev fl"><a href="http://ig.nore.me/aws/2014/08/securing-ssh-access-with-cloudformation/" rel="prev">Securing SSH access with CloudFormation</a></div>
                        <div class="nav-next fr"></div>
                    </nav>

                    </header>

                <section class="entry fix">

                

<p>In order to improve security for my EC2-instance, but still keep it useful, I came up with a script that automatically opens up SSH access for my current IP address.</p>

<h1 id="toc_0">Why did I do this?</h1>

<p>Yesterday I decided to take a look at the Trusted Advisor in the AWS console (at least the part of it that Amazon has made freely available). Most of what I found there wasn&rsquo;t a big shock, but one of them stood out to me: I left the SSH port on my EC2 instance open to the whole world.</p>

<p>Of course, when I did that I had a perfectly valid reason for it, as I wanted to be able to access my EC2 instance from anywhere. As access is limited by an SSH key anyway that seemed good enough. Of course, good enough isn&rsquo;t. So that needed to change.</p>

<h1 id="toc_1">How did I do it?</h1>

<p>The easiest solution was of course to restrict access to my IP address, and that&rsquo;s how I started. This meant I needed my external IP address. Easy enough to find, but as usual a bit of a hassle to go to the <a href="http://www.whatismyip.com">whatismyip.com website</a>. So, after finding my IP and updating the security group in my CloudFormation configuration, I decided that was enough and I made a <a href="http://www.smilesoftware.com/TextExpander/index.html">TextExpander</a> snippet to find the IP for me in the future.</p>

<pre><code class="language-language-bash">#!/bin/sh
/bin/echo -n `curl -s checkip.dyndns.org|sed -e 's/.*Current IP Address: //' -e 's/&lt;.*$//'`
</code></pre>

<p>Useful of course, but not the main reason for this article. The result of my changes so far was that I couldn&rsquo;t access the EC2 instance from anywhere other than home. At least not without changing the IP address in the CloudFormation template and updating it again.</p>

<p>This could be done in an easier way. I just had to change the CloudFormation template so that I could provide the IP as a parameter.</p>

<pre><code class="language-language-json">  &quot;Parameters&quot; : {
      &quot;SshIp&quot; : {
         &quot;Type&quot; : &quot;String&quot;,
         &quot;Default&quot; : &quot;10.0.0.0/24&quot;,
         &quot;Description&quot; : &quot;IP address that should have direct access through SSH&quot;
      }
</code></pre>

<p>By default it is set to only receive SSH connections from within its subnet, but I can override that by providing the IP address I want to have access. This of course is standard CloudFormation stuff, but it&rsquo;s also just the first step.</p>

<p>Combined with the TextExpander snippet I now had a fairly easy way to enable SSH access from my current IP, but it could still be easier. So, I wrote another function to include in my <a href="https://github.com/ArjenSchwarz/oh-my-zsh/blob/master/plugins/blogs/blogs.plugin.zsh">oh-my-zsh config</a>.</p>

<pre><code class="language-language-bash"># Update the cloudformation stack with my current external IP address
blogcfssh() {
  externalip=`curl -s checkip.dyndns.org | sed -e 's/.*Current IP Address: //' -e 's/&lt;.*$//'`
  echo &quot;Current IP is: ${externalip}\n&quot;
  echo &quot;Updating blog cloudformation template with current IP address&quot;
  cd ~/projects/server_personal; aws cloudformation update-stack --stack-name blog-server --template-body file://cloudformation-generated.json --parameters ParameterKey=SshIp,ParameterValue=${externalip}/32 --profile blogs
}
</code></pre>

<p>Using the above function, I retrieve my current IP address and fill it in as the parameter for the CloudFormation stack. This means that all I need to do to gain SSH access from my current location is to run <code>blogcfssh</code>. And as I have a similar function for updating the stack with just the default values, I can just as easily close this access.</p>

<h1 id="toc_2">Improvements</h1>

<p>This script isn&rsquo;t perfect yet, as it&rsquo;s too dependent on my current setup. Instead the CloudFormation template should be retrieved from an S3 bucket to ensure it works from everywhere. It would also be nice to have it automatically check if the update has finished and inform me of that.</p>


                </section>

                </article>


                </section>


    </div>

    <footer id="footer">

        <div class="footer-inner">

            <div id="copyright" class="col-left">
                <p>ig.nore.me &copy; 2014. All Rights Reserved.</p>
            </div>

            <div id="credit" class="col-right"></div>

        </div>

    </footer>

    </div>
</div>
    <script type="text/javascript">
    
        var disqus_shortname = 'ignoreme';
        (function () {
            var nodes = document.getElementsByTagName('span');
            for (var i = 0, url; i < nodes.length; i++) {
                if (nodes[i].className.indexOf('dsq-postid') != -1) {
                    nodes[i].parentNode.setAttribute('data-disqus-identifier', nodes[i].getAttribute('rel'));
                    url = nodes[i].parentNode.href.split('#', 1);
                    if (url.length == 1) url = url[0];
                    else url = url[1]
                    nodes[i].parentNode.href = url + '#disqus_thread';
                }
            }
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    
    </script>
    <div style="display:none">
    </div>


<script type='text/javascript' src='/js/prism.js'></script>

</body>
</html>